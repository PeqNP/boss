<div class="ui-window" style="width: 390px;">
  <script type="text/javascript">
    function $(this.id)(view) {
      function userDidSignIn(user) {
        view.ui.element("wordySplash").style.display = 'none';
        view.ui.element("wordyGame").style.display = 'block';
      }
      this.userDidSignIn = userDidSignIn;

      function userDidSignOut() {
        view.ui.element("wordySplash").style.display = 'block';
        view.ui.element("wordyGame").style.display = 'none';
      }
      this.userDidSignOut = userDidSignOut;

      async function viewDidLoad() {
        // Load stylesheet
        await os.network.stylesheet("$(app.resourcePath)/styles.css");

        view.ui.element("wordySplash").style.display = 'none';
        view.ui.element("wordyGame").style.display = 'none';
        if (os.isGuestUser(os.user)) {
          view.ui.element("wordySplash").style.display = 'block';
        }
        else {
          view.ui.element("wordyGame").style.display = 'block';
        }
      }
      this.viewDidLoad = viewDidLoad;

      // `addLetter` and `submitGuess` must be wrapped as the wordyGame UIController are not
      // defined by the time this controller is intialized.
      function addLetter(letter) {
        if (letter == "Backspace") {
          %(wordyGame).removeLetter();
        }
        else {
          %(wordyGame).addLetter(letter);
        }
      }
      function submitGuess() {
        %(wordyGame).submitGuess();
      }

      // Note: Key listeners must be defined on window.
      this.didHitKey = addLetter;
      this.didHitEnter = submitGuess;
    }
  </script>
  <div class="top">
    <div class="close-button"></div>
    <div class="title"><span>Wordy</span></div>
  </div>

  <div class="ui-controller container add-5" id="wordyGame">
    <script type="text/javascript">
      function wordyGame(view) {
        let selectedButton;
        let activeView;

        /**
         * Switch to controller and select respective button.
         */
        function switchView(buttonName, viewName, title) {
          // De-select the current button
          if (!isEmpty(selectedButton)) {
            view.ui.element(selectedButton).classList.remove("selected");
            view.ui.element(activeView).style.display = "none";
          }

          // Select the button
          view.ui.element(buttonName).classList.add("selected");
          // Note: The element is already `flex`
          view.ui.element(viewName).removeAttribute("style");
          selectedButton = buttonName;
          activeView = viewName;
          view.ui.element("wordy-title").textContent = title;
        }

        function showFriends() {
          switchView("wordy-nav-friends", "wordy-friends-view", "Friends");
          loadFriendResults();
        }
        this.showFriends = showFriends;

        function showStats() {
          switchView("wordy-nav-stats", "wordy-stats-view", "Statistics");
        }
        this.showStats = showStats;

        function showGame() {
          switchView("wordy-nav-game", "wordy-game-board-view", "Wordy");
        }
        this.showGame = showGame;

        function showSolver() {
          switchView("wordy-nav-solver", "wordy-solver-view", "Solver");
        }
        this.showSolver = showSolver;

        /** Animations **/

        /**
         * Rattle the respective guess row to indicate an invalid input.
         */
        function rattleGuess(guessRow) {
        }

        /**
         * Add letter to guess.
         */
        function addLetterToGuess(guess, letterCol, letter) {
          // Add `commit`
          let row = guess - 1;
          let elem = view.ui.element(`guess-${row}`);
          let letterElem = elem.querySelector(`.letter-${letterCol}`);
          letterElem.textContent = letter.toUpperCase();
        }

        /**
         * Remove the letter from guess.
         */
        function removeLetterFromGuess(guess, letterCol) {
          // Remove `commit`
          let row = guess - 1;
          let elem = view.ui.element(`guess-${row}`);
          let letterElem = elem.querySelector(`.letter-${letterCol}`);
          letterElem.textContent = "";
        }

        /**
         * Reveals whether the guess was solved or not.
         */
        function revealGuess(guess, state) {
          let row = guess - 1;
          let elem = view.ui.element(`guess-${row}`);
          for (let i = 0; i < state.matches.length; i++) {
            let match = state.matches[i];
            let letterCol = i;
            let letterElem = elem.querySelector(`.letter-${letterCol}`);
            letterElem.classList.add(match.state);
          }
        }

        /** Game **/

        // The current guess buffer. This will populate as the user types
        // letters into the active guess row.
        let guess = "";

        // The active guess number (default: the first guess `1`)
        let guessNumber = 1;

        // Indicates whether the current puzzle is solved or not.
        let solved = false;

        /**
         * Start a new game for the given date.
         *
         * @param {string} date? - The date to start game for. If `null`, this
         * will query for current day's puzzle.
         */
        function startNewGame(date) {
          guess = "";
          guessNumber = 1;
          solved = false;
          // TODO: Clear all rows

          // Remove state from all keys
          const letters = "abcdefghijklmnopqrstuvwxyz";
          for (const letter of letters) {
            let elem = view.ui.element(`wordy-letter-${letter}`);
            elem.classList.remove(...elem.classList);
          }
        }

        /**
         * Enter a letter into the guess.
         */
        function addLetter(letter) {
          if (solved) {
            console.warn("It should not be possible to add a letter to completed puzzle.");
            return;
          }

          // May not add another letter when all letters for guess have been provided
          if (guess.length >= 5) {
            rattleGuess(guessNumber);
            return;
          }

          // Must be an alphabetic value
          const isAlpha = /^[a-zA-Z]$/.test(letter);
          if (!isAlpha) {
            return;
          }

          guess += letter;
          let letterCol = guess.length - 1;
          addLetterToGuess(guessNumber, letterCol, letter);
        }
        this.addLetter = addLetter;

        /**
         * Remove letter from guess.
         */
        function removeLetter() {
          if (solved) {
            console.warn("It should not be possible to remove a letter when completed.");
            return;
          }

          // May not delete when no characters exist in guess
          if (guess.length < 1) {
            rattleGuess(guessNumber);
            return;
          }

          // Remove last letter from guess
          guess = guess.slice(0, -1);
          let letterCol = guess.length;
          removeLetterFromGuess(guessNumber, letterCol);
        }
        this.removeLetter = removeLetter;

        /**
         * Submit guess to server.
         */
        function submitGuess() {
          // A full guess has not been provided
          if (guess.length != 5) {
            rattleGuess(guessNumber);
            return;
          }

          // NOTE: This will all be backend logic
          const lowered = guess.toLowerCase();
          const targetWord = "alert";
          // The number of times each letter shows up in the target word.
          const targetWordPattern = {
            "a": 1,
            "l": 1,
            "e": 1,
            "r": 1,
            "t": 1
          };

          let patternMatches = {};
          let matches = [];
          let numHits = 0;

          // Keyboard keys (letters) that were used during the solving of the puzzle
          let keys = [
            {
              "letter": "a",
              "state": "hit"
            },
            {
              "letter": "e",
              "state": "hit"
            },
            {
              "letter": "t",
              "state": "found"
            },
            {
              "letter": "k",
              "state": "miss"
            },
          ];

          for (let i = 0; i < guess.length; i++) {
            let letter = guess[i];

            // Increase by 1 the number of times this letter shows up in the guess
            if (letter in patternMatches) {
              patternMatches[letter] += 1;
            }
            else {
              patternMatches[letter] = 1;
            }

            if (letter == targetWord[i]) {
              numHits += 1;
              matches[i] = {
                "letter": letter,
                "state": "hit"
              }
            }
            else if (targetWord.includes(letter)) {
              // If this letter has been shown <= to the number of times the letter
              // appears in the target word, then it is found.
              if (patternMatches[letter] <= targetWordPattern[letter]) {
                matches[i] = {
                  "letter": letter,
                  "state": "found"
                }
              }
              else {
                matches[i] = {
                  "letter": letter,
                  "state": "miss"
                }
              }
            }
            else {
              matches[i] = {
                "letter": letter,
                "state": "miss"
              }
            }
          }

          state = {
            "matches": matches,
            "solved": numHits == 5,
            "guessNumber": guessNumber,
            "nextGuessNumber": guessNumber + 1,
            "finished": guessNumber == 6,
            "keys": keys
          };
          // --- Backend ---

          // TODO: Update the keyboard

          // Reset the number just to be safe
          guessNumber = state.guessNumber;

          revealGuess(guessNumber, state);
          solved = state.solved;
          if (state.finished) {
            // TODO: Show view of today's solve w/ number attempts, etc. along with other user's who are playing.
            console.log("Puzzle finished");
          }
          else {
            guess = "";
            guessNumber = state.nextGuessNumber;

            for (const key of state.keys) {
              if (view.ui.element(`wordy-letter-${key.letter}`).classList.length < 1) {
                view.ui.element(`wordy-letter-${key.letter}`).classList.add(key.state);
              }
            }
          }
        }
        this.submitGuess = submitGuess;

        /** Friends **/

        /**
         * Load friend puzzle results for given data (default is today).
         */
        function loadFriendResults() {
          console.log("loadFriendResults");
          view.ui.div("puzzle-number").textContent = "Puzzle #1186 for 10/6/2025";
          let results = view.ui.div("friend-results");
          results.innerHTML = '';

          let avatar = document.createElement("img");
          avatar.src = "$(app.resourcePath)/img/solver.svg";
          avatar.alt = "Tristan";
          let name = document.createElement("p");
          name.textContent = "Tristan";
          let guesses = document.createElement("p");
          guesses.textContent = "5 guesses";
          let container = document.createElement("div");
          container.classList.add("wordy-friend-result", "hbox", "gap-10");
          container.appendChild(avatar);
          container.appendChild(name);
          container.appendChild(guesses);
          results.appendChild(container);
        }

        function manageFriends() {
          os.ui.openSettings(os.ui.SettingsLocation.friends);
        }
        this.manageFriends = manageFriends;

        /** Solver **/

        function solveWord() {
          console.log("Solving word...");
        }
        this.solveWord = solveWord;

        /** Lifecycle **/

        function viewDidLoad() {
          // Show the game board by default
          view.ui.element("wordy-friends-view").style.display = "none";
          view.ui.element("wordy-stats-view").style.display = "none";
          view.ui.element("wordy-solver-view").style.display = "none";
          showGame();
        }
        this.viewDidLoad = viewDidLoad;
      }
    </script>
    <div class="vbox gap-20">
      <div class="hbox separated" width="100%">
        <p id="wordy-title">Wordy</p>
        <div class="hbox align-right">
          <button id="wordy-nav-friends" class="image" onclick="%(wordyGame).showFriends();"><img src="$(app.resourcePath)/img/friend.svg" width="20" height="20"></button>
          <button id="wordy-nav-stats" class="image" onclick="%(wordyGame).showStats();"><img src="$(app.resourcePath)/img/podium.svg" width="20" height="20"></button>
          <button id="wordy-nav-game" class="image" onclick="%(wordyGame).showGame();"><img src="$(app.resourcePath)/icon.svg" width="20" height="20"></button>
          <button id="wordy-nav-solver" class="image" onclick="%(wordyGame).showSolver();"><img src="$(app.resourcePath)/img/solver.svg" width="20" height="20"></button>
        </div>
      </div>

      <div class="vbox gap-20" id="wordy-friends-view">
        <div class="puzzle-number"></div>

        <div class="friend-results vbox gap-5"></div>
        <div class="hbox align-center">
          <button class="primary" onclick="%(wordyGame).manageFriends();">Manage friends</button>
        </div>
        <!-- Manage friends button -->
      </div> <!-- wordy-friends-view -->

      <div id="wordy-stats-view">
        Statistics
      </div> <!-- wordy-stats-view -->

      <div class="vbox gap-20" id="wordy-game-board-view">
        <div class="vbox align-center gap-5"> <!-- Game board -->
          <div class="wordy-guess" id="guess-0">
            <div class="letter-0"></div>
            <div class="letter-1"></div>
            <div class="letter-2"></div>
            <div class="letter-3"></div>
            <div class="letter-4"></div>
          </div>
          <div class="wordy-guess" id="guess-1">
            <div class="letter-0"></div>
            <div class="letter-1"></div>
            <div class="letter-2"></div>
            <div class="letter-3"></div>
            <div class="letter-4"></div>
          </div>
          <div class="wordy-guess" id="guess-2">
            <div class="letter-0"></div>
            <div class="letter-1"></div>
            <div class="letter-2"></div>
            <div class="letter-3"></div>
            <div class="letter-4"></div>
          </div>
          <div class="wordy-guess" id="guess-3">
            <div class="letter-0"></div>
            <div class="letter-1"></div>
            <div class="letter-2"></div>
            <div class="letter-3"></div>
            <div class="letter-4"></div>
          </div>
          <div class="wordy-guess" id="guess-4">
            <div class="letter-0"></div>
            <div class="letter-1"></div>
            <div class="letter-2"></div>
            <div class="letter-3"></div>
            <div class="letter-4"></div>
          </div>
          <div class="wordy-guess" id="guess-5">
            <div class="letter-0"></div>
            <div class="letter-1"></div>
            <div class="letter-2"></div>
            <div class="letter-3"></div>
            <div class="letter-4"></div>
          </div>
        </div> <!-- Game board -->

        <div class="vbox gap-10 wordy-keyboard"> <!-- Keyboard -->
          <div class="hbox gap-5 align-center">
            <button id="wordy-letter-q" onclick="%(wordyGame).addLetter('Q');">Q</button>
            <button id="wordy-letter-w" onclick="%(wordyGame).addLetter('W');">W</button>
            <button id="wordy-letter-e" onclick="%(wordyGame).addLetter('E');">E</button>
            <button id="wordy-letter-r" onclick="%(wordyGame).addLetter('R');">R</button>
            <button id="wordy-letter-t" onclick="%(wordyGame).addLetter('T');">T</button>
            <button id="wordy-letter-y" onclick="%(wordyGame).addLetter('Y');">Y</button>
            <button id="wordy-letter-u" onclick="%(wordyGame).addLetter('U');">U</button>
            <button id="wordy-letter-i" onclick="%(wordyGame).addLetter('I');">I</button>
            <button id="wordy-letter-o" onclick="%(wordyGame).addLetter('O');">O</button>
            <button id="wordy-letter-p" onclick="%(wordyGame).addLetter('P');">P</button>
          </div>

          <div class="hbox gap-5 align-center">
            <button id="wordy-letter-a" onclick="%(wordyGame).addLetter('A');">A</button>
            <button id="wordy-letter-s" onclick="%(wordyGame).addLetter('S');">S</button>
            <button id="wordy-letter-d" onclick="%(wordyGame).addLetter('D');">D</button>
            <button id="wordy-letter-f" onclick="%(wordyGame).addLetter('F');">F</button>
            <button id="wordy-letter-g" onclick="%(wordyGame).addLetter('G');">G</button>
            <button id="wordy-letter-h" onclick="%(wordyGame).addLetter('H');">H</button>
            <button id="wordy-letter-j" onclick="%(wordyGame).addLetter('J');">J</button>
            <button id="wordy-letter-k" onclick="%(wordyGame).addLetter('K');">K</button>
            <button id="wordy-letter-l" onclick="%(wordyGame).addLetter('L');">L</button>
          </div>

          <div class="hbox gap-5 align-center">
            <button class="action" onclick="%(wordyGame).submitGuess();">return</button>
            <button id="wordy-letter-z" onclick="%(wordyGame).addLetter('Z');">Z</button>
            <button id="wordy-letter-x" onclick="%(wordyGame).addLetter('X');">X</button>
            <button id="wordy-letter-c" onclick="%(wordyGame).addLetter('C');">C</button>
            <button id="wordy-letter-v" onclick="%(wordyGame).addLetter('V');">V</button>
            <button id="wordy-letter-b" onclick="%(wordyGame).addLetter('B');">B</button>
            <button id="wordy-letter-n" onclick="%(wordyGame).addLetter('N');">N</button>
            <button id="wordy-letter-m" onclick="%(wordyGame).addLetter('M');">M</button>
            <button class="action" onclick="%(wordyGame).removeLetter();">delete</button>
          </div>
        </div> <!-- Keyboard -->
      </div> <!-- wordy-game-board-view -->

      <div class="vbox gap-20" id="wordy-solver-view">
        <div class="vbox align-center gap-5">
          <p>Enter solved (green) letters below. Use a question mark (?) for letters that are unsolved.</p>
          <div class="wordy-guess" id="solver-guess-0">
            <div class="letter-0"></div>
            <div class="letter-1"></div>
            <div class="letter-2"></div>
            <div class="letter-3"></div>
            <div class="letter-4"></div>
          </div>

          <p>Enter found (orange) letters below.</p>
          <div class="wordy-guess" id="solver-guess-1">
            <div class="letter-0"></div>
            <div class="letter-1"></div>
            <div class="letter-2"></div>
            <div class="letter-3"></div>
            <div class="letter-4"></div>
          </div>

          <div class="controls add-10-above">
            <button class="primary" onclick="%(wordyGame).solveWord();">Solve</button>
          </div>
        </div>

        <div class="vbox gap-5">
          <h3>Possible words</h3>
          <div class="ui-list-box" style="height: 300px;">
            <select name="possible-words"></select>
          </div>
        </div>
      </div> <!-- wordy-solver-view -->
    </div>
  </div> <!-- wordyGame -->

  <!-- First thing user sees if not signed in. -->
  <div class="ui-controller container" id="wordySplash">
    <script type="text/javascript">
      function wordySplash(view) {
        function showSignIn() {
          os.ui.showSignIn();
          console.log("showSignIn");
        }
        this.showSignIn = showSignIn;

        function showCreateAccount() {
          os.ui.showCreateAccount();
        }
        this.showCreateAccount = showCreateAccount;
      }
    </script>
    <div class="vbox gap-10">
      <p>Welcome to Wordy! The open source, 5 letter, guessing game.</p>
      <p>In order to play, you must sign in. If you don't have one, please create one (It's free).</p>
      <div class="controls">
        <button class="default" onclick="%(wordySplash).showCreateAccount();">Create account</button>
        <button class="default" onclick="%(wordySplash).showSignIn();">Sign in</button>
      </div>
    </div>
  </div> <!-- wordySplash -->

</div>
