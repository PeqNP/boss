<div class="ui-window" style="width: 390px;">
  <script type="text/javascript">
    function $(this.id)(view) {
      function userDidSignIn(user) {
        %(wordyGame).showGame();

        view.ui.element("wordySplash").style.display = 'none';
        view.ui.element("wordyGame").style.display = 'block';
      }
      this.userDidSignIn = userDidSignIn;

      function userDidSignOut() {
        view.ui.element("wordySplash").style.display = 'block';
        view.ui.element("wordyGame").style.display = 'none';
      }
      this.userDidSignOut = userDidSignOut;

      async function viewDidLoad() {
        // Load stylesheet
        await os.network.stylesheet("$(app.resourcePath)/styles.css");

        view.ui.element("wordySplash").style.display = 'none';
        view.ui.element("wordyGame").style.display = 'none';
        if (os.isGuestUser(os.user)) {
          view.ui.element("wordySplash").style.display = 'block';
        }
        else {
          view.ui.element("wordyGame").style.display = 'block';
        }
      }
      this.viewDidLoad = viewDidLoad;

      // `addLetter` and `submitGuess` must be wrapped as the wordyGame UIController are not
      // defined by the time this controller is intialized.
      function addLetter(letter) {
        if (letter == "Backspace") {
          %(wordyGame).removeLetter();
        }
        else {
          %(wordyGame).addLetter(letter);
        }
      }
      function submitGuess() {
        %(wordyGame).submitGuess();
      }

      // Note: Key listeners must be defined on window.
      this.didHitKey = addLetter;
      this.didHitEnter = submitGuess;
    }
  </script>
  <div class="top">
    <div class="close-button"></div>
    <div class="title"><span>Wordy</span></div>
  </div>

  <div class="ui-controller container add-5" id="wordyGame">
    <script type="text/javascript">
      function wordyGame(view) {
        let selectedButton;
        let activeView;

        /**
         * Switch to controller and select respective button.
         */
        function switchView(buttonName, viewName, title) {
          // De-select the current button
          if (!isEmpty(selectedButton)) {
            view.ui.element(selectedButton).classList.remove("selected");
            view.ui.element(activeView).style.display = "none";
          }

          // Select the button
          view.ui.element(buttonName).classList.add("selected");
          // Note: The element is already `flex`
          view.ui.element(viewName).removeAttribute("style");
          selectedButton = buttonName;
          activeView = viewName;
          view.ui.element("wordy-title").textContent = title;
        }

        function showFriends() {
          switchView("wordy-nav-friends", "wordy-friends-view", "Friends");
          loadFriendResults();
        }
        this.showFriends = showFriends;

        function showStats() {
          switchView("wordy-nav-stats", "wordy-stats-view", "Statistics");
          loadStats();
        }
        this.showStats = showStats;

        function showGame() {
          switchView("wordy-nav-game", "wordy-game-board-view", "Wordy");
          loadGame();
        }
        this.showGame = showGame;

        function showSolver() {
          switchView("wordy-nav-solver", "wordy-solver-view", "Solver");
        }
        this.showSolver = showSolver;

        /** Animations **/

        /**
         * Rattle the respective guess row to indicate an invalid input.
         */
        async function shakeGuess() {
          const elem = view.ui.element(`guess-${guessNumber}`);
          elem.classList.add('shake');
          await new Promise(resolve => setTimeout(resolve, 300));
          elem.classList.remove('shake');
        }

        /** Game Logic **/

        /**
         * Load the current user's word.
         */
        async function loadGame() {
          // Reset all game state
          guess = "";
          guessNumber = 0;
          solved = null;

          // Clear all attempt rows
          for (let i = 0; i < 6; i++) {
            let elem = view.ui.element(`guess-${i}`);
            for (let j = 0; j < 5; j++) {
              let letterElem = elem.querySelector(`.letter-${j}`);
              letterElem.classList.remove("hit", "miss", "found");
              letterElem.textContent = '';
            }
          }

          // Remove state from all keys
          const letters = "abcdefghijklmnopqrstuvwxyz";
          for (const letter of letters) {
            let elem = view.ui.element(`wordy-letter-${letter}`);
            elem.classList.remove(...elem.classList);
          }

          let puzzle;
          try {
            puzzle = await os.network.get("/api/io.bithead.wordy/word");
          }
          catch (error) {
            os.ui.showErrorModal("Failed to load current word. Please try again later.");
            return;
          }

          // Set state of existing puzzle
          if (puzzle.attempts.length > 0) {
            for (let i = 0; i < puzzle.attempts.length - 1; i++) {
              revealGuess(i, puzzle.attempts[i]);
            }
            let lastAttemptIdx = puzzle.attempts.length - 1;
            await revealGuess(lastAttemptIdx, puzzle.attempts[lastAttemptIdx]);

            guessNumber = puzzle.guessNumber;
            updateKeyStates(puzzle);
          }

          view.ui.span("wordy-puzzle-number").innerHTML = `${puzzle.wordId} for ${puzzle.date.replaceAll('-', '/')}`;
        }

        /**
         * Add letter to guess.
         */
        function addLetterToGuess(guess, letterCol, letter) {
          // Add `commit`
          let row = guess;
          let elem = view.ui.element(`guess-${row}`);
          let letterElem = elem.querySelector(`.letter-${letterCol}`);
          letterElem.textContent = letter.toUpperCase();
        }

        /**
         * Remove the letter from guess.
         */
        function removeLetterFromGuess(guess, letterCol) {
          // Remove `commit`
          let row = guess;
          let elem = view.ui.element(`guess-${row}`);
          let letterElem = elem.querySelector(`.letter-${letterCol}`);
          letterElem.textContent = "";
        }

        /**
         * Reveal matched letters from guess.
         *
         * @param {array} matches - Matched letters
         */
        async function revealGuess(guessNum, matches) {
          let elem = view.ui.element(`guess-${guessNum}`);
          for (let i = 0; i < matches.length; i++) {
            let match = matches[i];
            let letterCol = i;
            let letterElem = elem.querySelector(`.letter-${letterCol}`);
            letterElem.classList.add(match.state);
            letterElem.textContent = match.letter.toUpperCase();
          }
        }

        /** Game **/

        // The current guess buffer. This will populate as the user types
        // letters into the active guess row.
        let guess = "";

        // The active guess number (default: the first guess `0`)
        // 0=1st guess, 1=2nd guess, etc.
        let guessNumber = 0;

        // Indicates whether the current puzzle is solved or not.
        // null = not solved
        // true = solved successfully
        // false = failed to solve
        let solved = null;

        function addLetter(letter) {
          // Only add letters if the Wordy game, or solver, view is visible
          if (isEmpty(view.ui.element("wordy-game-board-view").style.display)) {
            addLetterToGameBoard(letter);
          }
          else if (isEmpty(view.ui.element("wordy-solver-view").style.display)) {
            addLetterToSolver(letter);
          }
        }
        this.addLetter = addLetter;

        /**
         * Add letter to the solver view.
         */
        function addLetterToSolver(letter) {
          console.log(`Add letter ${letter}`);
        }

        /**
         * Enter a letter into the guess.
         */
        function addLetterToGameBoard(letter) {
          if (solved !== null) {
            console.warn("It should not be possible to add a letter to completed puzzle.");
            return;
          }

          // May not add another letter when all letters for guess have been provided
          if (guess.length >= 5) {
            shakeGuess();
            return;
          }

          // Must be an alphabetic value
          const isAlpha = /^[a-zA-Z]$/.test(letter);
          if (!isAlpha) {
            return;
          }

          guess += letter;
          let letterCol = guess.length - 1;
          addLetterToGuess(guessNumber, letterCol, letter);
        }

        /**
         * Remove letter from guess.
         */
        function removeLetter() {
          if (solved !== null) {
            console.warn("It should not be possible to remove a letter when completed.");
            return;
          }

          // May not delete when no characters exist in guess
          if (guess.length < 1) {
            shakeGuess();
            return;
          }

          // Remove last letter from guess
          guess = guess.slice(0, -1);
          let letterCol = guess.length;
          removeLetterFromGuess(guessNumber, letterCol);
        }
        this.removeLetter = removeLetter;

        /**
         * Updates the key states if the puzzle is not solved.
         *
         * Otherwise, it shows the puzzle's stats.
         */
        async function updateKeyStates(puzzle) {
          for (let letter in puzzle.keys) {
            let keyState = puzzle.keys[letter];
            let elem = view.ui.element(`wordy-letter-${letter}`);
            // Already the same state
            if (elem.classList.contains(keyState)) {
              continue;
            }
            // Add (new) key state
            elem.classList.remove(...elem.classList);
            elem.classList.add(keyState);
          }

          if (puzzle.solved !== null) {
            // TODO: Show view of today's solve w/ number attempts, etc. along with other user's who are playing.
            console.log("Puzzle finished");
          }
        }

        /**
         * Submit guess to server.
         */
        async function submitGuess() {
          let response;
          try {
            response = await os.network.json("/api/io.bithead.wordy/guess", {word: guess});
          }
          catch (error) {
            os.ui.showErrorModal("Failed to submit guess. Please try again later.");
            return;
          }

          if (!response.validGuess) {
            shakeGuess();
            return;
          }

          let puzzle = response.puzzle;

          await revealGuess(guessNumber, puzzle.attempts.at(-1));

          guess = "";
          guessNumber = puzzle.guessNumber;
          updateKeyStates(puzzle);
        }
        this.submitGuess = submitGuess;

        /** Statistics **/

        async function loadStats() {
          let response;
          try {
            response = await os.network.get("/api/io.bithead.wordy/statistics");
          }
          catch (error) {
            os.ui.showErrorModal("Failed to query friend results. Please try again later.");
            return;
          }

          view.querySelector(".total-puzzles > span").textContent = response.played;
          view.querySelector(".current-streak > span").textContent = response.currentStreak;
          view.querySelector(".max-streak > span").textContent = response.maxStreak;

          let stats = view.ui.div("wordy-guess-stats").children;
          for (let i = 0; i < response.distribution.length; i++) {
            let bar = stats[i].querySelector(".ui-progress-bar");

            let number = response.distribution[i];
            if (number == 0) {
              bar.ui.setProgress(0, number);
            }
            else {
              let percent = (number / response.played) * 100;
              bar.ui.setProgress(percent, number);
            }
          }
        }

        /** Friends **/

        /**
         * Load friend puzzle results for given data (default is today).
         */
        async function loadFriendResults() {
          let response;
          try {
            response = await os.network.get("/api/io.bithead.wordy/friends");
          }
          catch (error) {
            os.ui.showErrorModal("Failed to query friend results. Please try again later.");
            return;
          }

          view.ui.div("puzzle-number").innerHTML = `<b>Puzzle #</b> ${response.puzzleNumber} for ${response.puzzleDate.replaceAll('-', '/')}`;
          let results = view.ui.div("friend-results");
          results.innerHTML = '';

          for (let i = 0; i < response.results.length; i++) {
            let result = response.results[i];
            let avatar = document.createElement("img");
            avatar.src = isEmpty(result.avatarUrl) ? '$(app.resourcePath)/icon.svg' : result.avatarUrl;
            avatar.alt = result.name;
            let name = document.createElement("p");
            name.textContent = result.name;
            let guesses = document.createElement("p");
            if (isEmpty(result.solved)) {
              if (result.numGuesses > 0) {
                guesses.textContent = `On attempt ${result.numGuesses + 1}`;
              }
              else {
                guesses.textContent = "Not started";
              }
            }
            else if (result.solved === true) {
              guesses.textContent = `${result.numGuesses} guesses`;
            }
            else {
              guesses.textContent = "Failed";
            }
            let container = document.createElement("div");
            container.classList.add("wordy-friend-result", "hbox", "gap-10");
            container.appendChild(avatar);
            container.appendChild(name);
            container.appendChild(guesses);
            results.appendChild(container);
          }
        }

        function manageFriends() {
          os.ui.openSettings(os.ui.SettingsLocation.friends);
        }
        this.manageFriends = manageFriends;

        /** Solver **/

        function solveWord() {
          console.log("Solving word...");
        }
        this.solveWord = solveWord;

        /** Lifecycle **/

        function viewDidLoad() {
          // Show the game board by default
          view.ui.element("wordy-friends-view").style.display = "none";
          view.ui.element("wordy-stats-view").style.display = "none";
          view.ui.element("wordy-solver-view").style.display = "none";
          showGame();
        }
        this.viewDidLoad = viewDidLoad;
      }
    </script>
    <div class="vbox gap-20">
      <div class="hbox separated" width="100%">
        <p id="wordy-title">Wordy</p>
        <div class="hbox align-right">
          <button id="wordy-nav-friends" class="image" onclick="%(wordyGame).showFriends();"><img src="$(app.resourcePath)/img/friend.svg" width="20" height="20"></button>
          <button id="wordy-nav-stats" class="image" onclick="%(wordyGame).showStats();"><img src="$(app.resourcePath)/img/podium.svg" width="20" height="20"></button>
          <button id="wordy-nav-game" class="image" onclick="%(wordyGame).showGame();"><img src="$(app.resourcePath)/icon.svg" width="20" height="20"></button>
          <button id="wordy-nav-solver" class="image" onclick="%(wordyGame).showSolver();"><img src="$(app.resourcePath)/img/solver.svg" width="20" height="20"></button>
        </div>
      </div>

      <div class="vbox gap-20" id="wordy-friends-view">
        <div class="puzzle-number text"></div>

        <div class="friend-results vbox gap-5"></div>
        <div class="hbox align-center">
          <button class="primary" onclick="%(wordyGame).manageFriends();">Manage friends</button>
        </div>
        <!-- Manage friends button -->
      </div> <!-- wordy-friends-view -->

      <div id="wordy-stats-view" class="vbox gap-20">
        <div class="hbox separated">
          <div class="total-puzzles statistic">
            <span>0</span>
            <label>Played</label>
          </div>
          <div class="current-streak statistic">
            <span>0</span>
            <label>Streak</label>
          </div>
          <div class="max-streak statistic">
            <span>0</span>
            <label>Max Streak</label>
          </div>
        </div>

        <div class="vbox gap-5">
          <h3>Guess distribution</h3>
          <div class="wordy-guess-stats vbox gap-5" style="width: 100%;">
            <div><p>1</p><div class="ui-progress-bar"></div></div>
            <div><p>2</p><div class="ui-progress-bar"></div></div>
            <div><p>3</p><div class="ui-progress-bar"></div></div>
            <div><p>4</p><div class="ui-progress-bar"></div></div>
            <div><p>5</p><div class="ui-progress-bar"></div></div>
            <div><p>6</p><div class="ui-progress-bar"></div></div>
          </div>
        </div>
      </div> <!-- wordy-stats-view -->

      <div class="vbox gap-20" id="wordy-game-board-view">
        <div class="vbox align-center gap-5"> <!-- Game board -->
          <div class="wordy-guess" id="guess-0">
            <div class="letter-0"></div>
            <div class="letter-1"></div>
            <div class="letter-2"></div>
            <div class="letter-3"></div>
            <div class="letter-4"></div>
          </div>
          <div class="wordy-guess" id="guess-1">
            <div class="letter-0"></div>
            <div class="letter-1"></div>
            <div class="letter-2"></div>
            <div class="letter-3"></div>
            <div class="letter-4"></div>
          </div>
          <div class="wordy-guess" id="guess-2">
            <div class="letter-0"></div>
            <div class="letter-1"></div>
            <div class="letter-2"></div>
            <div class="letter-3"></div>
            <div class="letter-4"></div>
          </div>
          <div class="wordy-guess" id="guess-3">
            <div class="letter-0"></div>
            <div class="letter-1"></div>
            <div class="letter-2"></div>
            <div class="letter-3"></div>
            <div class="letter-4"></div>
          </div>
          <div class="wordy-guess" id="guess-4">
            <div class="letter-0"></div>
            <div class="letter-1"></div>
            <div class="letter-2"></div>
            <div class="letter-3"></div>
            <div class="letter-4"></div>
          </div>
          <div class="wordy-guess" id="guess-5">
            <div class="letter-0"></div>
            <div class="letter-1"></div>
            <div class="letter-2"></div>
            <div class="letter-3"></div>
            <div class="letter-4"></div>
          </div>
        </div> <!-- Game board -->

        <div class="vbox gap-10 wordy-keyboard"> <!-- Keyboard -->
          <div class="hbox gap-5 align-center">
            <button id="wordy-letter-q" onclick="%(wordyGame).addLetter('Q');">Q</button>
            <button id="wordy-letter-w" onclick="%(wordyGame).addLetter('W');">W</button>
            <button id="wordy-letter-e" onclick="%(wordyGame).addLetter('E');">E</button>
            <button id="wordy-letter-r" onclick="%(wordyGame).addLetter('R');">R</button>
            <button id="wordy-letter-t" onclick="%(wordyGame).addLetter('T');">T</button>
            <button id="wordy-letter-y" onclick="%(wordyGame).addLetter('Y');">Y</button>
            <button id="wordy-letter-u" onclick="%(wordyGame).addLetter('U');">U</button>
            <button id="wordy-letter-i" onclick="%(wordyGame).addLetter('I');">I</button>
            <button id="wordy-letter-o" onclick="%(wordyGame).addLetter('O');">O</button>
            <button id="wordy-letter-p" onclick="%(wordyGame).addLetter('P');">P</button>
          </div>

          <div class="hbox gap-5 align-center">
            <button id="wordy-letter-a" onclick="%(wordyGame).addLetter('A');">A</button>
            <button id="wordy-letter-s" onclick="%(wordyGame).addLetter('S');">S</button>
            <button id="wordy-letter-d" onclick="%(wordyGame).addLetter('D');">D</button>
            <button id="wordy-letter-f" onclick="%(wordyGame).addLetter('F');">F</button>
            <button id="wordy-letter-g" onclick="%(wordyGame).addLetter('G');">G</button>
            <button id="wordy-letter-h" onclick="%(wordyGame).addLetter('H');">H</button>
            <button id="wordy-letter-j" onclick="%(wordyGame).addLetter('J');">J</button>
            <button id="wordy-letter-k" onclick="%(wordyGame).addLetter('K');">K</button>
            <button id="wordy-letter-l" onclick="%(wordyGame).addLetter('L');">L</button>
          </div>

          <div class="hbox gap-5 align-center">
            <button class="action" onclick="%(wordyGame).submitGuess();">return</button>
            <button id="wordy-letter-z" onclick="%(wordyGame).addLetter('Z');">Z</button>
            <button id="wordy-letter-x" onclick="%(wordyGame).addLetter('X');">X</button>
            <button id="wordy-letter-c" onclick="%(wordyGame).addLetter('C');">C</button>
            <button id="wordy-letter-v" onclick="%(wordyGame).addLetter('V');">V</button>
            <button id="wordy-letter-b" onclick="%(wordyGame).addLetter('B');">B</button>
            <button id="wordy-letter-n" onclick="%(wordyGame).addLetter('N');">N</button>
            <button id="wordy-letter-m" onclick="%(wordyGame).addLetter('M');">M</button>
            <button class="action" onclick="%(wordyGame).removeLetter();">delete</button>
          </div>
        </div> <!-- Keyboard -->

        <div class="text">
          <b>Puzzle #</b> <span name="wordy-puzzle-number"></span>
        </div>
      </div> <!-- wordy-game-board-view -->

      <div class="vbox gap-20" id="wordy-solver-view">
        <div class="vbox align-center gap-5">
          <p>Enter solved (green) letters below. Use a question mark (?) for letters that are unsolved.</p>
          <div class="wordy-guess" id="solver-guess-0">
            <div class="letter-0"></div>
            <div class="letter-1"></div>
            <div class="letter-2"></div>
            <div class="letter-3"></div>
            <div class="letter-4"></div>
          </div>

          <p>Enter found (orange) letters below.</p>
          <div class="wordy-guess" id="solver-guess-1">
            <div class="letter-0"></div>
            <div class="letter-1"></div>
            <div class="letter-2"></div>
            <div class="letter-3"></div>
            <div class="letter-4"></div>
          </div>

          <div class="controls add-10-above">
            <button class="primary" onclick="%(wordyGame).solveWord();">Solve</button>
          </div>
        </div>

        <div class="vbox gap-5">
          <h3>Possible words</h3>
          <div class="ui-list-box" style="height: 300px;">
            <select name="possible-words"></select>
          </div>
        </div>
      </div> <!-- wordy-solver-view -->
    </div>
  </div> <!-- wordyGame -->

  <!-- First thing user sees if not signed in. -->
  <div class="ui-controller container" id="wordySplash">
    <script type="text/javascript">
      function wordySplash(view) {
        function showSignIn() {
          os.ui.showSignIn();
          console.log("showSignIn");
        }
        this.showSignIn = showSignIn;

        function showCreateAccount() {
          os.ui.showCreateAccount();
        }
        this.showCreateAccount = showCreateAccount;
      }
    </script>
    <div class="vbox gap-10">
      <p>Welcome to Wordy! The open source, 5 letter, guessing game.</p>
      <p>In order to play, you must sign in. If you don't have one, please create one (It's free).</p>
      <div class="controls">
        <button class="default" onclick="%(wordySplash).showCreateAccount();">Create account</button>
        <button class="default" onclick="%(wordySplash).showSignIn();">Sign in</button>
      </div>
    </div>
  </div> <!-- wordySplash -->

</div>
