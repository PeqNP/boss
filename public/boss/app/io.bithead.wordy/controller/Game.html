<div class="ui-window" style="width: 390px;">
  <script language="text/javascript">
    function $(this.id)(view) {
      function userDidSignIn(user) {
        view.ui.element("wordySplash").style.display = 'none';
        view.ui.element("wordyGame").style.display = 'block';
      }
      this.userDidSignIn = userDidSignIn;

      function userDidSignOut() {
        view.ui.element("wordySplash").style.display = 'block';
        view.ui.element("wordyGame").style.display = 'none';
      }
      this.userDidSignOut = userDidSignOut;

      async function viewDidLoad() {
        // Load stylesheet
        await os.network.stylesheet("$(app.resourcePath)/styles.css");

        view.ui.element("wordySplash").style.display = 'none';
        view.ui.element("wordyGame").style.display = 'none';
        if (os.isGuestUser(os.user)) {
          view.ui.element("wordySplash").style.display = 'block';
        }
        else {
          view.ui.element("wordyGame").style.display = 'block';
        }
      }
      this.viewDidLoad = viewDidLoad;

      // `addLetter` and `submitGuess` must be wrapped as the wordyGame UIController are not
      // defined by the time this controller is intialized.
      function addLetter(letter) {
        if (letter == "Backspace") {
          %(wordyGame).removeLetter();
        }
        else {
          %(wordyGame).addLetter(letter);
        }
      }
      function submitGuess() {
        %(wordyGame).submitGuess();
      }

      // Note: Key listeners must be defined on window.
      this.didHitKey = addLetter;
      this.didHitEnter = submitGuess;
    }
  </script>
  <div class="top">
    <div class="close-button"></div>
    <div class="title"><span>Wordy</span></div>
  </div>

  <div class="ui-controller container add-5" id="wordyGame">
    <script language="text/javascript">
      function wordyGame(view) {
        let selectedButton;
        let activeView;

        /**
         * Switch to controller and select respective button.
         */
        function switchView(buttonName, viewName) {
          // De-select the current button
          if (!isEmpty(selectedButton)) {
            view.ui.element(selectedButton).classList.remove("selected");
            view.ui.element(activeView).style.display = "none";
          }

          // Select the button
          view.ui.element(buttonName).classList.add("selected");
          // Note: The element is already `flex`
          view.ui.element(viewName).removeAttribute("style");
          selectedButton = buttonName;
          activeView = viewName;
        }

        function showFriends() {
          switchView("wordy-nav-friends", "wordy-friends-view");
        }
        this.showFriends = showFriends;

        function showStats() {
          switchView("wordy-nav-stats", "wordy-stats-view");
        }
        this.showStats = showStats;

        function showGame() {
          switchView("wordy-nav-game", "wordy-game-board-view");
        }
        this.showGame = showGame;

        function showSolver() {
          switchView("wordy-nav-solver", "wordy-solver-view");
        }
        this.showSolver = showSolver;

        /** Animations **/

        /**
         * Rattle the respective guess row to indicate an invalid input.
         */
        function rattleGuess(guessRow) {
        }

        /**
         * Add letter to guess.
         */
        function addLetterToGuess(guess, letterCol, letter) {
          // Add `commit`
          let row = guess - 1;
          let elem = view.ui.element(`guess-${row}`);
          let letterElem = elem.querySelector(`.letter-${letterCol}`);
          letterElem.textContent = letter.toUpperCase();
        }

        /**
         * Remove the letter from guess.
         */
        function removeLetterFromGuess(guess, letterCol) {
          // Remove `commit`
          let row = guess - 1;
          let elem = view.ui.element(`guess-${row}`);
          let letterElem = elem.querySelector(`.letter-${letterCol}`);
          letterElem.textContent = "";
        }

        /**
         * Reveals whether the guess was solved or not.
         */
        function revealGuess(guess, state) {
          let row = guess - 1;
          let elem = view.ui.element(`guess-${row}`);
          for (let i = 0; i < state.matches.length; i++) {
            let match = state.matches[i];
            let letterCol = i;
            let letterElem = elem.querySelector(`.letter-${letterCol}`);
            letterElem.classList.add(match.state);
          }
        }

        /** Game **/

        // The current guess buffer. This will populate as the user types
        // letters into the active guess row.
        let guess = "";

        // The active guess number (default: the first guess `1`)
        let guessNumber = 1;

        // Indicates whether the current puzzle is solved or not.
        let solved = false;

        /**
         * Start a new game for the given date.
         *
         * @param {string} date? - The date to start game for. If `null`, this
         * will query for current day's puzzle.
         */
        function startNewGame(date) {
          guess = "";
          guessNumber = 1;
          solved = false;
          // TODO: Clear all rows
        }

        /**
         * Enter a letter into the guess.
         */
        function addLetter(letter) {
          if (solved) {
            console.warn("It should not be possible to add a letter to completed puzzle.");
            return;
          }

          // May not add another letter when all letters for guess have been provided
          if (guess.length >= 5) {
            rattleGuess(guessNumber);
            return;
          }

          // Must be an alphabetic value
          const isAlpha = /^[a-zA-Z]$/.test(letter);
          if (!isAlpha) {
            return;
          }

          guess += letter;
          let letterCol = guess.length - 1;
          addLetterToGuess(guessNumber, letterCol, letter);
        }
        this.addLetter = addLetter;

        /**
         * Remove letter from guess.
         */
        function removeLetter() {
          if (solved) {
            console.warn("It should not be possible to remove a letter when completed.");
            return;
          }

          // May not delete when no characters exist in guess
          if (guess.length < 1) {
            rattleGuess(guessNumber);
            return;
          }

          // Remove last letter from guess
          guess = guess.slice(0, -1);
          let letterCol = guess.length;
          removeLetterFromGuess(guessNumber, letterCol);
        }
        this.removeLetter = removeLetter;

        /**
         * Submit guess to server.
         */
        function submitGuess() {
          // A full guess has not been provided
          if (guess.length != 5) {
            rattleGuess(guessNumber);
            return;
          }

          // NOTE: This will all be backend logic
          const lowered = guess.toLowerCase();
          const targetWord = "alert";
          // The number of times each letter shows up in the target word.
          const targetWordPattern = {
            "a": 1,
            "l": 1,
            "e": 1,
            "r": 1,
            "t": 1
          };

          let patternMatches = {};
          let matches = [];
          let numHits = 0;

          for (let i = 0; i < guess.length; i++) {
            let letter = guess[i];

            // Increase by 1 the number of times this letter shows up in the guess
            if (letter in patternMatches) {
              patternMatches[letter] += 1;
            }
            else {
              patternMatches[letter] = 1;
            }

            if (letter == targetWord[i]) {
              numHits += 1;
              matches[i] = {
                "letter": letter,
                "state": "hit"
              }
            }
            else if (targetWord.includes(letter)) {
              // If this letter has been shown <= to the number of times the letter
              // appears in the target word, then it is found.
              if (patternMatches[letter] <= targetWordPattern[letter]) {
                matches[i] = {
                  "letter": letter,
                  "state": "found"
                }
              }
              else {
                matches[i] = {
                  "letter": letter,
                  "state": "miss"
                }
              }
            }
            else {
              matches[i] = {
                "letter": letter,
                "state": "miss"
              }
            }
          }

          state = {
            "matches": matches,
            "solved": numHits == 5,
            "guessNumber": guessNumber,
            "nextGuessNumber": guessNumber + 1,
            "finished": guessNumber == 6
          };
          // --- Backend ---

          // Reset the number just to be safe
          guessNumber = state.guessNumber;

          revealGuess(guessNumber, state);
          solved = state.solved;
          if (state.finished) {
            // TODO: Show view of today's solve w/ number attempts, etc. along with other user's who are playing.
            console.log("Puzzle finished");
          }
          else {
            guess = "";
            guessNumber = state.nextGuessNumber;
          }
        }
        this.submitGuess = submitGuess;

        /** Lifecycle **/

        function viewDidLoad() {
          // Show the game board by default
          view.ui.element("wordy-friends-view").style.display = "none";
          view.ui.element("wordy-stats-view").style.display = "none";
          view.ui.element("wordy-solver-view").style.display = "none";
          switchView("wordy-nav-game", "wordy-game-board-view");
        }
        this.viewDidLoad = viewDidLoad;
      }
    </script>
    <div class="vbox gap-20">
      <div class="hbox separated" width="100%">
        <p id="wordy-title">Wordy</p>
        <div class="hbox align-right">
          <button id="wordy-nav-friends" class="image" onclick="%(wordyGame).showFriends();"><img src="$(app.resourcePath)/img/friend.svg" width="20" height="20"></button>
          <button id="wordy-nav-stats" class="image" onclick="%(wordyGame).showStats();"><img src="$(app.resourcePath)/img/podium.svg" width="20" height="20"></button>
          <button id="wordy-nav-game" class="image" onclick="%(wordyGame).showGame();"><img src="$(app.resourcePath)/icon.svg" width="20" height="20"></button>
          <button id="wordy-nav-solver" class="image" onclick="%(wordyGame).showSolver();"><img src="$(app.resourcePath)/img/solver.svg" width="20" height="20"></button>
        </div>
      </div>

      <div id="wordy-friends-view">
        Friends
      </div> <!-- wordy-friends-view -->

      <div id="wordy-stats-view">
        Statistics
      </div> <!-- wordy-stats-view -->

      <div class="vbox gap-20" id="wordy-game-board-view">
        <div class="vbox align-center gap-5"> <!-- Game board -->
          <div class="wordy-guess" id="guess-0">
            <div class="letter-0"></div>
            <div class="letter-1"></div>
            <div class="letter-2"></div>
            <div class="letter-3"></div>
            <div class="letter-4"></div>
          </div>
          <div class="wordy-guess" id="guess-1">
            <div class="letter-0"></div>
            <div class="letter-1"></div>
            <div class="letter-2"></div>
            <div class="letter-3"></div>
            <div class="letter-4"></div>
          </div>
          <div class="wordy-guess" id="guess-2">
            <div class="letter-0"></div>
            <div class="letter-1"></div>
            <div class="letter-2"></div>
            <div class="letter-3"></div>
            <div class="letter-4"></div>
          </div>
          <div class="wordy-guess" id="guess-3">
            <div class="letter-0"></div>
            <div class="letter-1"></div>
            <div class="letter-2"></div>
            <div class="letter-3"></div>
            <div class="letter-4"></div>
          </div>
          <div class="wordy-guess" id="guess-4">
            <div class="letter-0"></div>
            <div class="letter-1"></div>
            <div class="letter-2"></div>
            <div class="letter-3"></div>
            <div class="letter-4"></div>
          </div>
          <div class="wordy-guess" id="guess-5">
            <div class="letter-0"></div>
            <div class="letter-1"></div>
            <div class="letter-2"></div>
            <div class="letter-3"></div>
            <div class="letter-4"></div>
          </div>
        </div> <!-- Game board -->

        <div class="vbox gap-10 wordy-keyboard"> <!-- Keyboard -->
          <div class="hbox gap-5 align-center">
            <button onclick="%(wordyGame).addLetter('Q');">Q</button>
            <button onclick="%(wordyGame).addLetter('W');">W</button>
            <button onclick="%(wordyGame).addLetter('E');">E</button>
            <button onclick="%(wordyGame).addLetter('R');">R</button>
            <button onclick="%(wordyGame).addLetter('T');">T</button>
            <button onclick="%(wordyGame).addLetter('Y');">Y</button>
            <button onclick="%(wordyGame).addLetter('U');">U</button>
            <button onclick="%(wordyGame).addLetter('I');">I</button>
            <button onclick="%(wordyGame).addLetter('O');">O</button>
            <button onclick="%(wordyGame).addLetter('P');">P</button>
          </div>

          <div class="hbox gap-5 align-center">
            <button onclick="%(wordyGame).addLetter('A');">A</button>
            <button onclick="%(wordyGame).addLetter('S');">S</button>
            <button onclick="%(wordyGame).addLetter('D');">D</button>
            <button onclick="%(wordyGame).addLetter('F');">F</button>
            <button onclick="%(wordyGame).addLetter('G');">G</button>
            <button onclick="%(wordyGame).addLetter('H');">H</button>
            <button onclick="%(wordyGame).addLetter('J');">J</button>
            <button onclick="%(wordyGame).addLetter('K');">K</button>
            <button onclick="%(wordyGame).addLetter('L');">L</button>
          </div>

          <div class="hbox gap-5 align-center">
            <button class="action" onclick="%(wordyGame).submitGuess();">return</button>
            <button onclick="%(wordyGame).addLetter('Z');">Z</button>
            <button onclick="%(wordyGame).addLetter('X');">X</button>
            <button onclick="%(wordyGame).addLetter('C');">C</button>
            <button onclick="%(wordyGame).addLetter('V');">V</button>
            <button onclick="%(wordyGame).addLetter('B');">B</button>
            <button onclick="%(wordyGame).addLetter('N');">N</button>
            <button onclick="%(wordyGame).addLetter('M');">M</button>
            <button class="action" onclick="%(wordyGame).removeLetter();">delete</button>
          </div>
        </div> <!-- Keyboard -->
      </div> <!-- wordy-game-board-view -->

      <div id="wordy-solver-view">
        Solver
      </div> <!-- wordy-solver-view -->
    </div>
  </div> <!-- wordyGame -->

  <!-- First thing user sees if not signed in. -->
  <div class="ui-controller container" id="wordySplash">
    <script type="text/javascript">
      function wordySplash(view) {
        function showSignIn() {
          os.ui.showSignIn();
          console.log("showSignIn");
        }
        this.showSignIn = showSignIn;

        function showCreateAccount() {
          os.ui.showCreateAccount();
        }
        this.showCreateAccount = showCreateAccount;
      }
    </script>
    <div class="vbox gap-10">
      <p>Welcome to Wordy! The open source, 5 letter, guessing game.</p>
      <p>In order to play, you must sign in. If you don't have one, please create one (It's free).</p>
      <div class="controls">
        <button class="default" onclick="%(wordySplash).showCreateAccount();">Create account</button>
        <button class="default" onclick="%(wordySplash).showSignIn();">Sign in</button>
      </div>
    </div>
  </div>
</div>
