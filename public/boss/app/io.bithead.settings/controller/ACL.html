<div class="ui-window">
  <script type="text/javascript">
    function $(this.id)(view) {
      // Configure user's ACL
      let userId;

      // Loaded ACL
      let acl;

      let delegate = protocol(
        "ACLDelegate", this, "delegate",
        ["didSaveACL", "didCancelACL"]
      );

      async function save() {
        // TODO:
        delegate.didSaveACL();
        view.ui.close();
      }
      this.save = save;

      function cancel() {
        // TODO:
        delegate.didCancelACL();
        view.ui.close();
      }
      this.cancel = cancel;

      function _delete() {
        // TODO:
      }
      this.delete = _delete;

      function configure(_userId) {
        userId = _userId;
      }
      this.configure = configure;

      async function loadAcl() {
        let response;
        try {
          response = await os.network.get(`/account/acl`);
        }
        catch {
          os.ui.showError("Failed to load ACL. Please try again later.");
          return;
        }

        acl = response;

        // TODO: Map the app's bundleId to respective name and replace
        let options = [];
        for (catalog of acl.tree.catalogs) {
          for (app of catalog.apps) {
            options.push(app);
          }
        }
        view.ui.select("apps").ui.addNewOptions(options, new UIListBoxChoiceConfig(true));
      }

      async function viewDidLoad() {
        if (isEmpty(userId)) {
          os.ui.showError("The ACL form must be configured with a User ID.");
          return;
        }

        view.ui.select("apps").ui.delegate = {
          didSelectListBoxOption: function (option) {
            // Remove all features
            let fs = view.ui.fieldset("features");
            let fss = fs.querySelectorAll(".acl-feature");
            if (fss.length > 0) {
              fs.removeChild(...fss);
            }

            // TODO: After loading, go through elements and set the correct selected/disabled state
            let allF = view.ui.fragment("acl-feature-fragment");
            allF.classList.remove(...allF.classList);
            let allC = allF.querySelector("input");
            allC.setAttribute("id", `full-access`);
            allC.addEventListener("change", function() {
              let checks = fs.querySelectorAll(".acl-feature input");
              let labels = fs.querySelectorAll(".acl-feature label");
              if (this.checked) {
                for (let elem of checks) {
                  elem.disabled = true;
                  elem.checked = false;
                }
                for (let elem of labels) {
                  elem.disabled = true;
                }
              }
              else {
                for (let elem of checks) {
                  elem.disabled = false;
                }
                for (let elem of labels) {
                  elem.disabled = false;
                }
              }
            });
            let allL = allF.querySelector("label");
            allL.setAttribute("for", `full-access`);
            allL.textContent = "Full access";
            fs.appendChild(allF);

            // Add new features
            for (let feature of option.data.features) {
              let frag = view.ui.fragment("acl-feature-fragment");
              let cb = frag.querySelector("input");
              cb.setAttribute("id", `acl-feature-${feature.id}`);
              cb.addEventListener("change", function() {
                if (this.checked) {
                  for (let perm of feature.permissions) {
                    let elem = document.getElementById(`acl-permission-${perm.id}`);
                    elem.disabled = true;
                    elem.checked = false;
                    elem = fs.querySelector(`label[for="acl-permission-${perm.id}"]`);
                    elem.disabled = true;
                  }
                }
                else {
                  for (let perm of feature.permissions) {
                    let elem = document.getElementById(`acl-permission-${perm.id}`);
                    elem.disabled = false;
                    elem = fs.querySelector(`label[for="acl-permission-${perm.id}"]`);
                    elem.disabled = false;
                  }
                }
              });
              let lb = frag.querySelector("label");
              lb.setAttribute("for", `acl-feature-${feature.id}`);
              lb.textContent = feature.name;
              let perms = frag.querySelector(".permissions");

              for (let permission of feature.permissions) {
                let _frag = view.ui.fragment("acl-permission-fragment");
                let _cb = _frag.querySelector("input");
                _cb.setAttribute("id", `acl-permission-${permission.id}`);
                let _lb = _frag.querySelector("label");
                _lb.setAttribute("for", `acl-permission-${permission.id}`);
                _lb.textContent = permission.name;
                perms.appendChild(_frag);
              }
              fs.appendChild(frag);
            }
          }
        };

        loadAcl();
      }
      this.viewDidLoad = viewDidLoad;

      this.didHitEnter = save;
    }
  </script>
  <div class="ui-menus">
    <div class="ui-menu" style="width: 180px;">
      <select name="user-menu">
        <option>File</option>
        <option onclick="$(this.controller).save();">Save</option>
        <option class="group"></option>
        <option onclick="$(this.controller).delete();" value="delete">Delete</option>
        <option onclick="$(this.controller).cancel();">Cancel</option>
      </select>
    </div>
  </div>
  <div class="top">
    <div class="close-button"></div>
    <div class="title"><span>ACL</span></div>
    <div class="zoom-button"></div>
  </div>
  <div class="container vbox gap-10" style="width: 550px">
    <div class="hbox gap-10" style="height: 300px;">
      <div class="vbox ratio-1 gap-5">
        <h2>Apps</h2>
        <div class="ui-list-box">
          <select name="apps"></select>
        </div>
      </div>

      <fieldset name="features" class="vbox ratio-1 gap-10 scrollable" style="margin-top: 19px;">
        <legend>Features</legend>
      </fieldset>
    </div>

    <div class="controls">
      <button class="default" onclick="$(this.controller).save();" disabled>Save</button>
    </div>
  </div>
  <fragment id="acl-feature-fragment">
    <div class="acl-feature" style="background-color: #ebebeb; padding: 5px;">
      <div class="checkbox-field"><input type="checkbox"> <label></label></div>
      <div class="permissions hbox gap-10 checkbox-field" style="margin-left: 18px;"></div>
    </div>
  </fragment>
  <fragment id="acl-permission-fragment">
    <div class="acl-permission">
      <input type="checkbox"> <label></label>
    </div>
  </fragment>
</div>
