<div class="ui-window">
  <script type="text/javascript">
    function $(this.id)(view) {
      // The user to configure ACL for
      let user;

      // The full ACL tree
      let acl;

      // The bundle ID of the currently selected app
      let bundleId;
      // The license for the currently selected app
      let license = null;
      // The ACL for the currently selected app
      let userAcl = [];

      let delegate = protocol(
        "ACLDelegate", this, "delegate",
        ["didSaveACL", "didCancelACL"]
      );

      async function save() {
        if (isEmpty(bundleId)) {
          console.log("Will not save when no app bundle has been selected.");
          return;
        }

        // Add (new) ACLs
        let issueLicense = false;
        let addAclIds = [];
        let checks = view.querySelectorAll('input[type="checkbox"]');
        for (let check of checks) {
          if (isEmpty(check.data)) {
            continue; // fragment>input
          }
          else if (check.id == "issue-license") {
            issueLicense = check.checked;
          }
          else if (!check.disabled && check.checked) {
            addAclIds.push(check.data.id);
          }
        }

        // Remove ACLs, if needed
        let removeAclIds = [];
        for (let aclId of userAcl) {
          if (!addAclIds.includes(aclId)) {
            removeAclIds.push(aclId);
          }
        }

        let body = {
          userId: parseInt(user.id),
          bundleId: bundleId,
          issueLicense: issueLicense,
          addAcl: addAclIds,
          removeAcl: removeAclIds
        };
        try {
          response = await os.network.post(`/account/assign-acl`, body);
        }
        catch {
          os.ui.showError("Failed to assign ACL. Please try again later.");
          return;
        }
        delegate.didSaveACL();
        view.ui.close();
      }
      this.save = save;

      function cancel() {
        delegate.didCancelACL();
        view.ui.close();
      }
      this.cancel = cancel;

      function configure(_user) {
        user = _user;
      }
      this.configure = configure;

      async function loadUserAcl() {
        let body = {
          userId: parseInt(user.id),
          bundleId: bundleId
        };
        let response;
        try {
          response = await os.network.post(`/account/user-acl`, body);
        }
        catch {
          os.ui.showError("Failed to load ACL. Please try again later.");
          return;
        }

        license = response.license;
        userAcl = response.acl;
      }

      async function loadAclTree() {
        let response;
        try {
          response = await os.network.get("/account/acl-tree");
        }
        catch {
          os.ui.showError("Failed to load ACL. Please try again later.");
          return;
        }

        acl = response;

        // TODO: Show the app's name over the bundle ID(?)
        let options = [];
        for (catalog of acl.tree.catalogs) {
          for (app of catalog.apps) {
            options.push(app);
          }
        }
        view.ui.select("apps").ui.addNewOptions(options, new UIListBoxChoiceConfig(true));
      }

      async function viewDidLoad() {
        if (isEmpty(user)) {
          os.ui.showError("The ACL form must be configured with a User ID.");
          return;
        }

        document.getElementById("acl-user").innerHTML = `<b>User:</b> ${user.name}`;

        view.ui.select("apps").ui.delegate = {
          didSelectListBoxOption: async function (option) {
            bundleId = option.text;

            // ACL must be loaded before trying to create ACL inputs
            await loadUserAcl();

            // Remove all features
            let fs = view.ui.div("features");
            let fss = fs.querySelectorAll(".acl-feature");
            if (fss.length > 0) {
              fs.removeChild(...fss);
            }

            function makeIssueLicense() {
              let frag = view.ui.fragment("app-license-fragment");
              let check = frag.querySelector("input");
              check.data = option.data;
              fs.appendChild(frag);
            }

            function makeFullAccess(_id, name) {
              let frag = view.ui.fragment("acl-feature-fragment");
              frag.classList.remove(...frag.classList);
              let check = frag.querySelector("input");
              check.setAttribute("id", "full-access");
              check.data = option.data;
              check.addEventListener("change", function() {
                let checks = fs.querySelectorAll(".acl-feature input");
                let labels = fs.querySelectorAll(".acl-feature label");
                if (this.checked) {
                  for (let elem of checks) {
                    elem.disabled = true;
                    elem.checked = false;
                  }
                  for (let elem of labels) {
                    elem.disabled = true;
                  }
                }
                else {
                  for (let elem of checks) {
                    elem.disabled = false;
                  }
                  for (let elem of labels) {
                    elem.disabled = false;
                  }
                }
              });
              let label = frag.querySelector("label");
              label.setAttribute("for", "full-access");
              label.textContent = "Full access";
              fs.appendChild(frag);
            }

            // Create the `Issue license` which allows a user to use the app.
            makeIssueLicense();

            // Create the `Full access` feature, which gives full access to all
            // features within an app.
            makeFullAccess();

            // Add new features
            for (let feature of option.data.features) {
              let frag = view.ui.fragment("acl-feature-fragment");
              let cb = frag.querySelector("input");
              cb.setAttribute("id", `acl-feature-${feature.id}`);
              cb.data = feature;
              cb.addEventListener("change", function() {
                if (this.checked) {
                  for (let perm of feature.permissions) {
                    let elem = document.getElementById(`acl-permission-${perm.id}`);
                    elem.disabled = true;
                    elem.checked = false;
                    elem = fs.querySelector(`label[for="acl-permission-${perm.id}"]`);
                    elem.disabled = true;
                  }
                }
                else {
                  for (let perm of feature.permissions) {
                    let elem = document.getElementById(`acl-permission-${perm.id}`);
                    elem.disabled = false;
                    elem = fs.querySelector(`label[for="acl-permission-${perm.id}"]`);
                    elem.disabled = false;
                  }
                }
              });
              let lb = frag.querySelector("label");
              lb.setAttribute("for", `acl-feature-${feature.id}`);
              lb.textContent = feature.name;
              let perms = frag.querySelector(".permissions");

              for (let permission of feature.permissions) {
                let _frag = view.ui.fragment("acl-permission-fragment");
                let _cb = _frag.querySelector("input");
                _cb.setAttribute("id", `acl-permission-${permission.id}`);
                _cb.data = permission;
                let _lb = _frag.querySelector("label");
                _lb.setAttribute("for", `acl-permission-${permission.id}`);
                _lb.textContent = permission.name;
                perms.appendChild(_frag);
              }
              fs.appendChild(frag);
            }

            let checks = view.querySelectorAll('input[type="checkbox"]');
            for (let check of checks) {
              if (isEmpty(check.data)) {
                continue; // fragment>input
              }
              else if (check.id == "issue-license") {
                check.checked = !isEmpty(license);
              }
              else if (userAcl.includes(check.data.id)) {
                check.checked = true;
                check.dispatchEvent(new Event('change'));
              }
            }
          }
        };

        loadAclTree();
      }
      this.viewDidLoad = viewDidLoad;

      this.didHitEnter = save;
    }
  </script>
  <div class="ui-menus">
    <div class="ui-menu" style="width: 180px;">
      <select name="user-menu">
        <option>File</option>
        <option onclick="$(this.controller).save();">Save</option>
        <option class="group"></option>
        <option onclick="$(this.controller).cancel();">Cancel</option>
      </select>
    </div>
  </div>
  <div class="top">
    <div class="close-button"></div>
    <div class="title"><span>ACL</span></div>
    <div class="zoom-button"></div>
  </div>
  <div class="container vbox gap-10" style="width: 550px">
    <div class="hbox gap-10" style="height: 300px;">
      <div class="vbox ratio-1 gap-5">
        <h2>Apps</h2>
        <div class="ui-list-box">
          <select name="apps"></select>
        </div>
      </div>

      <div class="vbox ratio-1 gap-5">
        <h2>Features</h2>
        <div class="features vbox gap-separator scrollable bordered expanded"></div>
      </div>
    </div>

    <div class="controls separated align-left">
      <div class="text align-left" style="flex: 1;"><p id="acl-user" ></p></div>
      <div>
        <button class="primary" onclick="$(this.controller).cancel();">Cancel</button>
        <button class="default" onclick="$(this.controller).save();">Save</button>
      <div>
    </div>
  </div>
  <fragment id="app-license-fragment">
    <div style="padding: 5px;">
      <div class="checkbox-field"><input type="checkbox" id="issue-license"> <label for="issue-license">Issue license</label></div>
    </div>
  </fragment>
  <fragment id="acl-feature-fragment">
    <div class="acl-feature" style="padding: 5px;">
      <div class="checkbox-field"><input type="checkbox"> <label></label></div>
      <div class="permissions hbox gap-15 checkbox-field" style="margin-left: 18px;"></div>
    </div>
  </fragment>
  <fragment id="acl-permission-fragment">
    <div class="acl-permission">
      <input type="checkbox"> <label></label>
    </div>
  </fragment>
</div>
