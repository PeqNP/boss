<div class="ui-window">
  <script type="text/javascript">
    function $(this.id)(view) {
      // UserDelegate
      let delegate = {
        didSaveUser: loadUsers,
        didDeleteUser: loadUsers
      };

      async function editUser() {
        let ctrl = await $(app.controller).loadController("User");
        let userId = view.ui.select("users").ui.selectedValue();
        ctrl.ui.show(function (controller) {
          controller.delegate = delegate;
          controller.configure(userId);
        });
      }
      this.editUser = editUser;

      async function addUser() {
        let ctrl = await $(app.controller).loadController("User");
        ctrl.ui.show(function(controller) {
          controller.delegate = delegate;
        });
      }
      this.addUser = addUser;

      function close() {
        view.ui.close();
      }
      this.close = close;

      // Friends

      async function showFriends() {
        view.ui.div("friends").style.display = null;
        view.ui.div("users").style.display = 'none';
        view.ui.select("settings").ui.selectValue(1);

        view.ui.button("remove-friend").disabled = true;

        await loadFriends();
      }

      async function loadFriends() {
        try {
          let response = await os.network.get(`/friend`);
        }
        catch {
          os.ui.showErrorModal("Failed to load friends. Please try again later.");
          return;
        }

        view.ui.select("friend-requests").ui.addNewOptions(response.friendRequests);
        view.ui.select("your-requests").ui.addNewOptions(response.yourRequests);
        view.ui.select("friends").ui.addNewOptions(response.friends);
        // TODO: Show pending, request to us, and friends in the same list
        // Pending your approval
        // Requests you sent
        // Your friends
      }

      function addFriend() {
        console.log("Add friend");
      }
      this.addFriend = addFriend;

      /**
       * Remove a friend or friend request.
       *
       * This function is overloaded, but it simplifies the UI.
       */
      function removeFriend() {
        console.log("Remove friend");
      }
      this.removeFriend = removeFriend;

      // Users

      async function showUsers() {
        view.ui.div("friends").style.display = 'none';
        view.ui.div("users").style.display = null;
        view.ui.select("settings").ui.selectValue(0);

        await loadUsers();
      }

      async function loadUsers() {
        let response = await os.network.get(`/account/users`);
        view.ui.select("users").ui.addNewOptions(response.users);
      }

      async function viewDidLoad() {
        showUsers();

        view.ui.select("users").ui.setDefaultAction(editUser);
        let select = view.ui.select("settings").ui;
        select.delegate = {
          didSelectListBoxOption: function(opt) {
            if (opt.index == 0) {
              showUsers();
            }
            else if (opt.index == 1) {
              showFriends();
            }
          }
        }
      }
      this.viewDidLoad = viewDidLoad;

      this.didHitEnter = function() {
        if (view.ui.select("settings").ui.selectedIndex() == 0) {
          editUser();
        }
      };
    }
  </script>
  <div class="ui-menus">
    <div class="ui-menu" style="width: 180px;">
      <select name="home-menu">
        <option>File</option>
        <option onclick="$(this.controller).addUser();">Add user</option>
        <option class="group"></option>
        <option onclick="$(this.controller).addFriend();">Add friend</option>
        <option class="group"></option>
        <option onclick="$(this.controller).close();">Close</option>
      </select>
    </div>
  </div>
  <div class="top">
    <div class="close-button"></div>
    <div class="title"><span>Settings</span></div>
    <div class="zoom-button"></div>
  </div>
  <div class="container">
    <div class="hbox gap-10">
      <div class="ui-list-box" style="width: 140px; height: 366px;">
        <select name="settings">
          <option>Users</option>
          <option>Friends</option>
        </select>
      </div>

      <div class="users">
        <div class="hbox gap-10">
          <div class="ui-list-box" style="width: 300px; height: 220px;">
            <select name="users">
            </select>
          </div>

          <div class="vbox separated" style="width: 140px;">
            <div class="vbox gap-10">
              <button class="primary" onclick="$(this.controller).addUser();">Add user</button>
            </div>
            <div class="vbox gap-10">
              <button class="default" onclick="$(this.controller).editUser();">Edit</button>
            </div>
          </div>
        </div>
      </div> <!-- users -->

      <div class="friends">
        <div class="hbox gap-10">
          <div class"vbox">
            <h4>Pending your approval</h4>
            <div class="ui-list-box add-10" style="width: 300px; height: 40px;">
              <select name="friend-requests"></select>
            </div>

            <h4>Your requests</h4>
            <div class="ui-list-box add-10" style="width: 300px; height: 40px;">
              <select name="your-requests"></select>
            </div>

            <h4>Friends</h4>
            <div class="ui-list-box" style="width: 300px; height: 200px;">
              <select name="friends"></select>
            </div>
          </div> <!-- Friend lists -->

          <div class="vbox separated" style="width: 140px;">
            <div class="vbox gap-10">
              <button class="primary" onclick="$(this.controller).addFriend();">Add friend</button>
            </div>
            <div class="vbox gap-10">
              <button name="remove-friend" class="primary" onclick="$(this.controller).removeFriend();">Remove</button>
            </div>
          </div> <!-- Controls -->
        </div>
      </div> <!-- users -->

    </div> <!-- hbox -->
  </div> <!-- container -->
</div>
