<div class="ui-window">
  <script type="text/javascript">
    function $(this.id)(view) {
      // The settings location to open when first opening settings
      let loc = null;

      // UserDelegate
      let delegate = {
        didSaveUser: loadUsers,
        didDeleteUser: function (user) {
          if (user.id == os.user.id) {
            os.forceLogOut();
            view.ui.close();
            return;
          }

          loadUsers();
        }
      };

      async function manageACL() {
        let ctrl = await $(app.controller).loadController("ACL");
        let option = view.ui.select("users").ui.selectedOption();
        ctrl.ui.show(function (controller) {
          // NOTE: No need to configure delegate. Nothing in the UI is refreshed when it changes (yet)
          controller.configure(option.data);
        });
      }
      this.manageACL = manageACL;

      async function editUser() {
        let ctrl = await $(app.controller).loadController("User");
        let userId = view.ui.select("users").ui.selectedValue();
        ctrl.ui.show(function (controller) {
          controller.delegate = delegate;
          controller.configure(userId);
        });
      }
      this.editUser = editUser;

      async function addUser() {
        let ctrl = await $(app.controller).loadController("User");
        ctrl.ui.show(function(controller) {
          controller.delegate = delegate;
        });
      }
      this.addUser = addUser;

      function close() {
        view.ui.close();
      }
      this.close = close;

      // Friends

      async function showFriends() {
        view.ui.div("friends").style.display = null;
        view.ui.div("users").style.display = 'none';
        view.ui.select("settings").ui.selectOption(1);

        await loadFriends();
      }
      this.showFriends = showFriends;

      async function showPendingRequests() {
        await showFriends();
        let select = view.ui.select("friends-tabs")
        select.ui.selectTabIndex(1);
      }
      this.showPendingRequests = showPendingRequests;

      function addFriendsToLists(response) {
        view.ui.select("friends").ui.addNewOptions(response.friends);
        view.ui.select("friend-requests").ui.addNewOptions(response.friendRequests);
        view.ui.select("my-requests").ui.addNewOptions(response.yourRequests);

        let select = view.ui.select("friends-tabs")
        select.ui.setTabLabel(0, `My friends (${response.friends.length})`);
        select.ui.setTabLabel(1, `Pending requests (${response.friendRequests.length})`);
        select.ui.setTabLabel(2, `My requests(${response.yourRequests.length})`);
      }

      async function loadFriends() {
        let response;
        try {
          response = await os.network.get(`/friend`);
        }
        catch {
          os.ui.showError("Failed to load friends. Please try again later.");
          return;
        }

        addFriendsToLists(response);
      }

      /**
       * Add a new friend to my friends list.
       *
       * Displays a modal that asks, and submits, friend's e-mail.
       *
       * Reloads friends.
       */
      async function addFriend() {
        let win = await $(app.controller).loadController("AddFriend");
        win.ui.show(function(ctrl) {
          ctrl.delegate = {
            didSendFriendRequest: function(response) {
              addFriendsToLists(response);
            }
          }
        });
      }
      this.addFriend = addFriend;

      /**
       * Remove a friend from my list.
       *
       * This function is overloaded, but it simplifies the UI.
       */
      async function removeFriend() {
        let option = view.ui.select("friends").ui.selectedOption();
        // It should not be possible to select call this function w/o selecting an option
        if (isEmpty(option)) { return; }

        os.ui.showDelete(
          `Are you sure you want to remove ${option.text} from your friends?`,
          null,
          async function () {
            let response;
            try {
              response = await os.network.post(`/friend/remove`, {id: parseInt(option.value)});
            }
            catch {
              os.ui.showError("Failed to remove friend. Please try again later.");
              return;
            }
            addFriendsToLists(response);
          }
        );
      }
      this.removeFriend = removeFriend;

      /**
       * Accept a friend request.
       */
      async function acceptFriendRequest() {
        let value = view.ui.select("friend-requests").ui.selectedValue();
        if (isEmpty(value)) { return; }

        let response;
        try {
          response = await os.network.post(`/friend/accept`, {id: parseInt(value)});
        }
        catch {
          os.ui.showError("Failed to accept friend request. Please try again later.");
          return;
        }
        addFriendsToLists(response);
      }
      this.acceptFriendRequest = acceptFriendRequest;

      /**
       * Reject a friend request.
       *
       * @param {string?} - Optional field name that contains selected value.
       *    Default: friend-requests
       */
      async function rejectFriendRequest(fieldName) {
        if (isEmpty(fieldName)) {
          fieldName = "friend-requests";
        }

        let value = view.ui.select(fieldName).ui.selectedValue();
        if (isEmpty(value)) { return; }

        let response;
        try {
          response = await os.network.post(`/friend/reject`, {id: parseInt(value)});
        }
        catch {
          os.ui.showError("Failed to reject friend request. Please try again later.");
          return;
        }
        addFriendsToLists(response);
      }
      this.rejectFriendRequest = rejectFriendRequest;

      /**
       * Remove a friend request that I made.
       */
      function removeMyFriendRequest() {
        rejectFriendRequest("my-requests");
      }
      this.removeMyFriendRequest = removeMyFriendRequest;

      // Users

      async function showUsers() {
        view.ui.div("friends").style.display = 'none';
        view.ui.div("users").style.display = null;
        view.ui.select("settings").ui.selectOption(0);

        await loadUsers();
      }

      async function loadUsers() {
        let response = await os.network.get(`/account/users`);
        view.ui.select("users").ui.addNewOptions(response.users, {setModelToData: true});
      }

      function showFriendList(name) {
        view.ui.div("my-friends-list").style.display = 'none';
        view.ui.div("pending-requests-list").style.display = 'none';
        view.ui.div("my-requests-list").style.display = 'none';
        view.ui.div(name).style.display = null;
      }

      function configure(_loc) {
        // Window is already displayed
        let isLoaded = !isEmpty(loc);

        loc = isEmpty(_loc) ? os.ui.SettingsLocation.users : _loc;

        if (isLoaded) {
          switchLocation();
        }
      }
      this.configure = configure;

      function switchLocation() {
        if (os.ui.SettingsLocation.friends == loc) {
          showFriends();
        }
        else {
          showUsers();
        }
      }

      async function viewDidLoad() {
        showFriendList("my-friends-list");

        view.ui.button("show-acl").style.display = os.isSuperUser(os.user) ? null : 'none';

        view.ui.select("users").ui.setDefaultAction(editUser);
        let select = view.ui.select("settings").ui;
        select.delegate = {
          didSelectListBoxOption: function(opt) {
            if (opt.index == 0) {
              showUsers();
            }
            else if (opt.index == 1) {
              showFriends();
            }
          }
        }

        let tabs = view.ui.select("friends-tabs");
        tabs.ui.delegate = {
          didSelectTab: function(tab) {
            if (tab.index == 0) {
              showFriendList("my-friends-list");
            }
            else if (tab.index == 1) {
              showFriendList("pending-requests-list");
            }
            else if (tab.index == 2) {
              showFriendList("my-requests-list");
            }
          }
        }

        view.ui.select("friends").ui.delegate = {
          didSelectListBoxOption: function(opt) {
            view.ui.button("remove-friend").disabled = false;
          },
          didRemoveAllOptions: function(opt) {
            view.ui.button("remove-friend").disabled = true;
          }
        };

        view.ui.select("my-requests").ui.delegate = {
          didSelectListBoxOption: function(opt) {
            view.ui.button("remove-friend-request").disabled = false;
          },
          didRemoveAllOptions: function(opt) {
            view.ui.button("remove-friend-request").disabled = true;
          }
        };

        view.ui.select("friend-requests").ui.delegate = {
          didSelectListBoxOption: function(opt) {
            view.ui.button("accept-friend-request").disabled = false;
            view.ui.button("reject-friend-request").disabled = false;
          },
          didRemoveAllOptions: function(opt) {
            view.ui.button("accept-friend-request").disabled = true;
            view.ui.button("reject-friend-request").disabled = true;
          }
        };

        switchLocation();
      }
      this.viewDidLoad = viewDidLoad;

      this.didHitEnter = function() {
        if (view.ui.select("settings").ui.selectedIndex() == 0) {
          editUser();
        }
      };

      this.events = {
        "io.bithead.boss.friends.refresh": async function() {
          await loadFriends();
        }
      };
    }
  </script>
  <div class="ui-menus">
    <div class="ui-menu" style="width: 180px;">
      <select name="home-menu">
        <option>File</option>
        <option onclick="$(this.controller).addUser();">Add user</option>
        <option class="group"></option>
        <option onclick="$(this.controller).addFriend();">Add friend</option>
        <option class="group"></option>
        <option onclick="$(this.controller).close();">Close</option>
      </select>
    </div>
  </div>
  <div class="top">
    <div class="close-button"></div>
    <div class="title"><span>Settings</span></div>
    <div class="zoom-button"></div>
  </div>
  <div class="container">
    <div class="hbox gap-10">
      <!-- TODO: Is it possible to make this expand height depending on window selected? -->
      <div class="ui-list-box" style="width: 140px; height: 220px;">
        <select name="settings">
          <option>Users</option>
          <option>Friends</option>
        </select>
      </div>

      <div class="users">
        <div class="hbox gap-10">
          <div class="ui-list-box" style="width: 300px; height: 220px;">
            <select name="users">
            </select>
          </div>

          <div class="controls-right separated">
            <div class="vbox gap-10">
              <button class="primary" onclick="$(this.controller).addUser();">Add user</button>
            </div>
            <div class="vbox gap-10">
              <button name="show-acl" class="primary" onclick="$(this.controller).manageACL();">ACL</button>
              <button class="default" onclick="$(this.controller).editUser();">Edit</button>
            </div>
          </div>
        </div>
      </div> <!-- users -->

      <div class="friends vbox gap-10">
        <div class="ui-tabs">
          <select name="friends-tabs">
            <option>My friends</option>
            <option>Pending requests</option>
            <option>My requests</option>
          </select>
        </div>

        <div class="my-friends-list hbox gap-10">
          <div class="ui-list-box" style="width: 300px; height: 180px;">
            <select name="friends"></select>
          </div>
          <div class="controls-right separated">
            <div class="vbox">
              <button class="primary" onclick="$(this.controller).addFriend();">Add friend</button>
            </div>
            <div class="vbox gap-10">
              <button name="remove-friend" class="primary" onclick="$(this.controller).removeFriend();">Remove</button>
            </div>
          </div>
        </div> <!-- my-friends-list -->

        <div class="pending-requests-list hbox gap-10">
          <div class="ui-list-box" style="width: 300px; height: 180px;">
            <select name="friend-requests"></select>
          </div>
          <div class="controls-right">
            <button name="reject-friend-request" class="primary" onclick="$(this.controller).rejectFriendRequest();">Reject</button>
            <button name="accept-friend-request" class="default" onclick="$(this.controller).acceptFriendRequest();">Accept</button>
          </div>
        </div> <!-- pending-requests-list -->

        <div class="my-requests-list hbox gap-10">
          <div class="ui-list-box" style="width: 300px; height: 180px;">
            <select name="my-requests"></select>
          </div>
          <div class="controls-right">
            <button name="remove-friend-request" class="primary" onclick="$(this.controller).removeMyFriendRequest();">Remove</button>
          </div>
        </div> <!-- my-requests-list -->
      </div> <!-- friends -->

    </div> <!-- hbox -->
  </div> <!-- container -->
</div>
